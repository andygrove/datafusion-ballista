select
    supp_nation,
    cust_nation,
    l_year,
    sum(volume) as revenue
from
    (
        select
            n1.n_name as supp_nation,
            n2.n_name as cust_nation,
            extract(year from l_shipdate) as l_year,
            l_extendedprice * (1 - l_discount) as volume
        from
            supplier,
            lineitem,
            orders,
            customer,
            nation n1,
            nation n2
        where
                s_suppkey = l_suppkey
          and o_orderkey = l_orderkey
          and c_custkey = o_custkey
          and s_nationkey = n1.n_nationkey
          and c_nationkey = n2.n_nationkey
          and (
                (n1.n_name = 'FRANCE' and n2.n_name = 'GERMANY')
                or (n1.n_name = 'GERMANY' and n2.n_name = 'FRANCE')
            )
          and l_shipdate between date '1995-01-01' and date '1996-12-31'
    ) as shipping
group by
    supp_nation,
    cust_nation,
    l_year
order by
    supp_nation,
    cust_nation,
    l_year;


Query Stage 0:
ShuffleWriterExec: Some(Hash([Column { name: "n_nationkey", index: 0 }], 8))
  CoalesceBatchesExec: target_batch_size=8192
    FilterExec: n_name@1 = GERMANY OR n_name@1 = FRANCE
      ParquetExec: file_groups={1 group: [[mnt/bigdata/tpch/sf100/nation.parquet/part1.parquet]]}, projection=[n_nationkey, n_name], predicate=n_name@1 = GERMANY OR n_name@1 = FRANCE, pruning_predicate=CASE WHEN n_name_null_count@2 = n_name_row_count@3 THEN false ELSE n_name_min@0 <= GERMANY AND GERMANY <= n_name_max@1 END OR CASE WHEN n_name_null_count@2 = n_name_row_count@3 THEN false ELSE n_name_min@0 <= FRANCE AND FRANCE <= n_name_max@1 END, required_guarantees=[n_name in (GERMANY, FRANCE)]

Query Stage 1:
ShuffleWriterExec: Some(Hash([Column { name: "n_nationkey", index: 0 }], 8))
  CoalesceBatchesExec: target_batch_size=8192
    FilterExec: n_name@1 = FRANCE OR n_name@1 = GERMANY
      ParquetExec: file_groups={1 group: [[mnt/bigdata/tpch/sf100/nation.parquet/part1.parquet]]}, projection=[n_nationkey, n_name], predicate=n_name@1 = FRANCE OR n_name@1 = GERMANY, pruning_predicate=CASE WHEN n_name_null_count@2 = n_name_row_count@3 THEN false ELSE n_name_min@0 <= FRANCE AND FRANCE <= n_name_max@1 END OR CASE WHEN n_name_null_count@2 = n_name_row_count@3 THEN false ELSE n_name_min@0 <= GERMANY AND GERMANY <= n_name_max@1 END, required_guarantees=[n_name in (GERMANY, FRANCE)]

Query Stage 2:
ShuffleWriterExec: Some(Hash([Column { name: "c_custkey", index: 0 }], 8))
  ParquetExec: file_groups={8 groups: [[mnt/bigdata/tpch/sf100/customer.parquet/part1.parquet:0..78209135, mnt/bigdata/tpch/sf100/customer.parquet/part10.parquet:0..78199486], [mnt/bigdata/tpch/sf100/customer.parquet/part10.parquet:78199486..78230419, mnt/bigdata/tpch/sf100/customer.parquet/part11.parquet:0..78213009, mnt/bigdata/tpch/sf100/customer.parquet/part12.parquet:0..78164679], [mnt/bigdata/tpch/sf100/customer.parquet/part12.parquet:78164679..78184439, mnt/bigdata/tpch/sf100/customer.parquet/part13.parquet:0..78214803, mnt/bigdata/tpch/sf100/customer.parquet/part14.parquet:0..78174058], [mnt/bigdata/tpch/sf100/customer.parquet/part14.parquet:78174058..78203896, mnt/bigdata/tpch/sf100/customer.parquet/part15.parquet:0..78207662, mnt/bigdata/tpch/sf100/customer.parquet/part16.parquet:0..78171121], [mnt/bigdata/tpch/sf100/customer.parquet/part16.parquet:78171121..78199415, mnt/bigdata/tpch/sf100/customer.parquet/part2.parquet:0..78172558, mnt/bigdata/tpch/sf100/customer.parquet/part3.parquet:0..78198064, mnt/bigdata/tpch/sf100/customer.parquet/part4.parquet:0..9705], [mnt/bigdata/tpch/sf100/customer.parquet/part4.parquet:9705..78221511, mnt/bigdata/tpch/sf100/customer.parquet/part5.parquet:0..78196815], [mnt/bigdata/tpch/sf100/customer.parquet/part5.parquet:78196815..78206183, mnt/bigdata/tpch/sf100/customer.parquet/part6.parquet:0..78200661, mnt/bigdata/tpch/sf100/customer.parquet/part7.parquet:0..78198592], [mnt/bigdata/tpch/sf100/customer.parquet/part7.parquet:78198592..78215057, mnt/bigdata/tpch/sf100/customer.parquet/part8.parquet:0..78193102, mnt/bigdata/tpch/sf100/customer.parquet/part9.parquet:0..78199052]]}, projection=[c_custkey, c_nationkey]

Query Stage 3:
ShuffleWriterExec: Some(Hash([Column { name: "s_suppkey", index: 0 }], 8))
  ParquetExec: file_groups={8 groups: [[mnt/bigdata/tpch/sf100/supplier.parquet/part1.parquet:0..5503838, mnt/bigdata/tpch/sf100/supplier.parquet/part10.parquet:0..5497270, mnt/bigdata/tpch/sf100/supplier.parquet/part11.parquet:0..1793], [mnt/bigdata/tpch/sf100/supplier.parquet/part11.parquet:1793..5508630, mnt/bigdata/tpch/sf100/supplier.parquet/part12.parquet:0..5496064], [mnt/bigdata/tpch/sf100/supplier.parquet/part12.parquet:5496064..5498685, mnt/bigdata/tpch/sf100/supplier.parquet/part13.parquet:0..5504379, mnt/bigdata/tpch/sf100/supplier.parquet/part14.parquet:0..5495901], [mnt/bigdata/tpch/sf100/supplier.parquet/part14.parquet:5495901..5502882, mnt/bigdata/tpch/sf100/supplier.parquet/part15.parquet:0..5499373, mnt/bigdata/tpch/sf100/supplier.parquet/part16.parquet:0..5496547], [mnt/bigdata/tpch/sf100/supplier.parquet/part16.parquet:5496547..5503828, mnt/bigdata/tpch/sf100/supplier.parquet/part2.parquet:0..5498113, mnt/bigdata/tpch/sf100/supplier.parquet/part3.parquet:0..5496774, mnt/bigdata/tpch/sf100/supplier.parquet/part4.parquet:0..733], [mnt/bigdata/tpch/sf100/supplier.parquet/part4.parquet:733..5495657, mnt/bigdata/tpch/sf100/supplier.parquet/part5.parquet:0..5502994, mnt/bigdata/tpch/sf100/supplier.parquet/part6.parquet:0..4983], [mnt/bigdata/tpch/sf100/supplier.parquet/part6.parquet:4983..5503668, mnt/bigdata/tpch/sf100/supplier.parquet/part7.parquet:0..5504216], [mnt/bigdata/tpch/sf100/supplier.parquet/part7.parquet:5504216..5508016, mnt/bigdata/tpch/sf100/supplier.parquet/part8.parquet:0..5498618, mnt/bigdata/tpch/sf100/supplier.parquet/part9.parquet:0..5500477]]}, projection=[s_suppkey, s_nationkey]

Query Stage 4:
ShuffleWriterExec: Some(Hash([Column { name: "l_suppkey", index: 1 }], 8))
  CoalesceBatchesExec: target_batch_size=8192
    FilterExec: l_shipdate@4 >= 1995-01-01 AND l_shipdate@4 <= 1996-12-31
      ParquetExec: file_groups={8 groups: [[mnt/bigdata/tpch/sf100/lineitem.parquet/part1.parquet:0..1469550136, mnt/bigdata/tpch/sf100/lineitem.parquet/part10.parquet:0..1469810475], [mnt/bigdata/tpch/sf100/lineitem.parquet/part10.parquet:1469810475..1469811062, mnt/bigdata/tpch/sf100/lineitem.parquet/part11.parquet:0..1469792487, mnt/bigdata/tpch/sf100/lineitem.parquet/part12.parquet:0..1469567537], [mnt/bigdata/tpch/sf100/lineitem.parquet/part12.parquet:1469567537..1469576762, mnt/bigdata/tpch/sf100/lineitem.parquet/part13.parquet:0..1469839488, mnt/bigdata/tpch/sf100/lineitem.parquet/part14.parquet:0..1469511898], [mnt/bigdata/tpch/sf100/lineitem.parquet/part14.parquet:1469511898..1469647240, mnt/bigdata/tpch/sf100/lineitem.parquet/part15.parquet:0..1469833433, mnt/bigdata/tpch/sf100/lineitem.parquet/part16.parquet:0..1469391836], [mnt/bigdata/tpch/sf100/lineitem.parquet/part16.parquet:1469391836..1469765133, mnt/bigdata/tpch/sf100/lineitem.parquet/part2.parquet:0..1469212062, mnt/bigdata/tpch/sf100/lineitem.parquet/part3.parquet:0..1469775252], [mnt/bigdata/tpch/sf100/lineitem.parquet/part3.parquet:1469775252..1469794280, mnt/bigdata/tpch/sf100/lineitem.parquet/part4.parquet:0..1469768080, mnt/bigdata/tpch/sf100/lineitem.parquet/part5.parquet:0..1469573503], [mnt/bigdata/tpch/sf100/lineitem.parquet/part5.parquet:1469573503..1469812961, mnt/bigdata/tpch/sf100/lineitem.parquet/part6.parquet:0..1469938331, mnt/bigdata/tpch/sf100/lineitem.parquet/part7.parquet:0..1469182822], [mnt/bigdata/tpch/sf100/lineitem.parquet/part7.parquet:1469182822..1469651669, mnt/bigdata/tpch/sf100/lineitem.parquet/part8.parquet:0..1469328494, mnt/bigdata/tpch/sf100/lineitem.parquet/part9.parquet:0..1469563265]]}, projection=[l_orderkey, l_suppkey, l_extendedprice, l_discount, l_shipdate], predicate=l_shipdate@10 >= 1995-01-01 AND l_shipdate@10 <= 1996-12-31, pruning_predicate=CASE WHEN l_shipdate_null_count@1 = l_shipdate_row_count@2 THEN false ELSE l_shipdate_max@0 >= 1995-01-01 END AND CASE WHEN l_shipdate_null_count@1 = l_shipdate_row_count@2 THEN false ELSE l_shipdate_min@3 <= 1996-12-31 END, required_guarantees=[]

Query Stage 5:
ShuffleWriterExec: Some(Hash([Column { name: "l_orderkey", index: 1 }], 8))
  CoalesceBatchesExec: target_batch_size=8192
    HashJoinExec: mode=Partitioned, join_type=Inner, on=[(s_suppkey@0, l_suppkey@1)], projection=[s_nationkey@1, l_orderkey@2, l_extendedprice@4, l_discount@5, l_shipdate@6]
      CoalesceBatchesExec: target_batch_size=8192
        UnresolvedShuffleExec
      CoalesceBatchesExec: target_batch_size=8192
        UnresolvedShuffleExec

Query Stage 6:
ShuffleWriterExec: Some(Hash([Column { name: "o_orderkey", index: 0 }], 8))
  ParquetExec: file_groups={8 groups: [[mnt/bigdata/tpch/sf100/orders.parquet/part1.parquet:0..414015218, mnt/bigdata/tpch/sf100/orders.parquet/part10.parquet:0..414048620, mnt/bigdata/tpch/sf100/orders.parquet/part11.parquet:0..38879], [mnt/bigdata/tpch/sf100/orders.parquet/part11.parquet:38879..414036634, mnt/bigdata/tpch/sf100/orders.parquet/part12.parquet:0..414048473, mnt/bigdata/tpch/sf100/orders.parquet/part13.parquet:0..56489], [mnt/bigdata/tpch/sf100/orders.parquet/part13.parquet:56489..414046189, mnt/bigdata/tpch/sf100/orders.parquet/part14.parquet:0..414061303, mnt/bigdata/tpch/sf100/orders.parquet/part15.parquet:0..51714], [mnt/bigdata/tpch/sf100/orders.parquet/part15.parquet:51714..414057732, mnt/bigdata/tpch/sf100/orders.parquet/part16.parquet:0..414039840, mnt/bigdata/tpch/sf100/orders.parquet/part2.parquet:0..56859], [mnt/bigdata/tpch/sf100/orders.parquet/part2.parquet:56859..414037014, mnt/bigdata/tpch/sf100/orders.parquet/part3.parquet:0..414067201, mnt/bigdata/tpch/sf100/orders.parquet/part4.parquet:0..55361], [mnt/bigdata/tpch/sf100/orders.parquet/part4.parquet:55361..414066732, mnt/bigdata/tpch/sf100/orders.parquet/part5.parquet:0..414028297, mnt/bigdata/tpch/sf100/orders.parquet/part6.parquet:0..63049], [mnt/bigdata/tpch/sf100/orders.parquet/part6.parquet:63049..414092946, mnt/bigdata/tpch/sf100/orders.parquet/part7.parquet:0..414072820], [mnt/bigdata/tpch/sf100/orders.parquet/part7.parquet:414072820..414077818, mnt/bigdata/tpch/sf100/orders.parquet/part8.parquet:0..414070661, mnt/bigdata/tpch/sf100/orders.parquet/part9.parquet:0..414027051]]}, projection=[o_orderkey, o_custkey]

Query Stage 7:
ShuffleWriterExec: Some(Hash([Column { name: "o_custkey", index: 4 }], 8))
  CoalesceBatchesExec: target_batch_size=8192
    HashJoinExec: mode=Partitioned, join_type=Inner, on=[(l_orderkey@1, o_orderkey@0)], projection=[s_nationkey@0, l_extendedprice@2, l_discount@3, l_shipdate@4, o_custkey@6]
      CoalesceBatchesExec: target_batch_size=8192
        UnresolvedShuffleExec
      CoalesceBatchesExec: target_batch_size=8192
        UnresolvedShuffleExec

Query Stage 8:
ShuffleWriterExec: Some(Hash([Column { name: "s_nationkey", index: 0 }], 8))
  ProjectionExec: expr=[s_nationkey@1 as s_nationkey, l_extendedprice@2 as l_extendedprice, l_discount@3 as l_discount, l_shipdate@4 as l_shipdate, c_nationkey@0 as c_nationkey]
    CoalesceBatchesExec: target_batch_size=8192
      HashJoinExec: mode=Partitioned, join_type=Inner, on=[(c_custkey@0, o_custkey@4)], projection=[c_nationkey@1, s_nationkey@2, l_extendedprice@3, l_discount@4, l_shipdate@5]
        CoalesceBatchesExec: target_batch_size=8192
          UnresolvedShuffleExec
        CoalesceBatchesExec: target_batch_size=8192
          UnresolvedShuffleExec

Query Stage 9:
ShuffleWriterExec: Some(Hash([Column { name: "c_nationkey", index: 3 }], 8))
  ProjectionExec: expr=[l_extendedprice@1 as l_extendedprice, l_discount@2 as l_discount, l_shipdate@3 as l_shipdate, c_nationkey@4 as c_nationkey, n_name@0 as n_name]
    CoalesceBatchesExec: target_batch_size=8192
      HashJoinExec: mode=Partitioned, join_type=Inner, on=[(n_nationkey@0, s_nationkey@0)], projection=[n_name@1, l_extendedprice@3, l_discount@4, l_shipdate@5, c_nationkey@6]
        CoalesceBatchesExec: target_batch_size=8192
          UnresolvedShuffleExec
        CoalesceBatchesExec: target_batch_size=8192
          UnresolvedShuffleExec

Query Stage 10:
ShuffleWriterExec: Some(Hash([Column { name: "supp_nation", index: 0 }, Column { name: "cust_nation", index: 1 }, Column { name: "l_year", index: 2 }], 8))
  AggregateExec: mode=Partial, gby=[supp_nation@0 as supp_nation, cust_nation@1 as cust_nation, l_year@2 as l_year], aggr=[SUM(shipping.volume)]
    ProjectionExec: expr=[n_name@4 as supp_nation, n_name@0 as cust_nation, date_part(YEAR, l_shipdate@3) as l_year, l_extendedprice@1 * (Some(1),20,0 - l_discount@2) as volume]
      CoalesceBatchesExec: target_batch_size=8192
        HashJoinExec: mode=Partitioned, join_type=Inner, on=[(n_nationkey@0, c_nationkey@3)], filter=n_name@0 = FRANCE AND n_name@1 = GERMANY OR n_name@0 = GERMANY AND n_name@1 = FRANCE, projection=[n_name@1, l_extendedprice@2, l_discount@3, l_shipdate@4, n_name@6]
          CoalesceBatchesExec: target_batch_size=8192
            UnresolvedShuffleExec
          CoalesceBatchesExec: target_batch_size=8192
            UnresolvedShuffleExec

Query Stage 11:
ShuffleWriterExec: None
  SortExec: expr=[supp_nation@0 ASC NULLS LAST,cust_nation@1 ASC NULLS LAST,l_year@2 ASC NULLS LAST], preserve_partitioning=[true]
    ProjectionExec: expr=[supp_nation@0 as supp_nation, cust_nation@1 as cust_nation, l_year@2 as l_year, SUM(shipping.volume)@3 as revenue]
      AggregateExec: mode=FinalPartitioned, gby=[supp_nation@0 as supp_nation, cust_nation@1 as cust_nation, l_year@2 as l_year], aggr=[SUM(shipping.volume)]
        CoalesceBatchesExec: target_batch_size=8192
          UnresolvedShuffleExec

Query Stage 12:
ShuffleWriterExec: None
  SortPreservingMergeExec: [supp_nation@0 ASC NULLS LAST,cust_nation@1 ASC NULLS LAST,l_year@2 ASC NULLS LAST]
    UnresolvedShuffleExec

